# steps: run terraform
variables:
  - group: 'cloudfront-vars'

stages:
  - stage: 'AWS_Deploy'
    jobs:
    - job: 'Deploy'
      steps:
        - task: AWSShellScript@1
          displayName: 'Do nothing'
          inputs:
            awsCredentials: AWSServiceConnection
            regionName: us-west-2
            failOnStandardError: true
            scriptType: inline
            inlineScript: |
              echo "ECHO"
              aws sts get-caller-identity
              
              sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
              
              wget -O- https://apt.releases.hashicorp.com/gpg | \
              gpg --dearmor | \
              sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
              
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              
              sudo apt update
              
              sudo apt-get install terraform
              
              terraform -help

